<!-- http://codepen.io/jamesbarnett/pen/kcwzq -->
<!DOCTYPE html>
<html>
	<head>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"  charset="utf-8"></script>
		<script src="//listjs.com/no-cdn/list.js"></script>
		<script src="//listjs.com/no-cdn/list.pagination.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
		<link href="{{ STATIC_URL }}projects/moviero/css/moviero.css" rel="stylesheet" type="text/css"/>
		<link href='//cdn.jsdelivr.net/jquery.nouislider/8.0.2/nouislider.min.css' rel="stylesheet"/>
		<meta charset=utf-8 />
		<script>
  			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	
	  		ga('create', 'UA-66787829-1', 'auto');
  			ga('send', 'pageview');
		</script>
		<title>Moviero</title>
		<style>
			#slider-container {
				z-index: 2;
			}

			#date-slider {
				height: 10px;
				background: #444;
			}
	
			.noUi-connect {
				background: #DE5E60;
			}
	
			.date-val {
				float: left;
			}
	
			.noUi-target {
				border-radius: 20px;
				border: 1px solid rgba(0, 0, 0, 0.05);
				box-shadow: none;
			}
	
			.noUi-background {
				background: #444;
				box-shadow: none;
			}
	
			.noUi-horizontal .noUi-handle {
				width: 20px;
				height: 20px;
				left: -17px;
				top: -8px;
				border-radius: 20px;
			}

			.noUi-handle:after, .noUi-handle:before{
				display:none;
			}
		</style>
	</head>
	<body>
		<div id="container">
			<div class="example-page">
				<div id="main">
					<div class="c1">
						<div id="lovely-things-list" style='display:inline-block'>
							<div class="col-12">
								<input class="search" placeholder="Search Title, Artist, Director or Plot..."></input>
							</div>
							<div class="col-7">
								<ul class="sort-by">
									<li class='control-head'> Sort by:</li>
									<li class="sort btn" data-sort="metascore">Metascore</li>
									<li class="sort btn" data-sort="name">Name</li>
									<li class="sort btn" data-sort="air_date">Air Date</li>
								</ul>
							</div>
							<div id='slider-container' class='col-5' >
								<div>
									<div id="date-slider"></div>
								</div>
								<div class='col-6'>
									<span class="date-val" id="event-start"></span>
								</div>
								<div class='col-6'> 	
									<span class="date-val" id="event-end" style='float: right;'></span>
								</div>
							</div>
							<!--
							<ul class="sort-order">
								<li class='control-head'> Sort Order:</li>
								<li class="btn highlight" id="filter-none"><input type="radio" name="group4"/></li>
								<li class="btn" id="filter-none"><input type="radio" name="group4"/></li>
							</ul>
							-->
							<div class="col-12">
								<ul class="filter">
									<li class='control-head'>Genre:&nbsp;&nbsp;&nbsp;</li>
									<li class="btn highlight">All</li>
								</ul>
							</div>
							<div class="col-12">
								<ul class="pagination"></ul>
							</div>
							<div class="col-12">
								<ul class="list" id='list'></ul>
							</div>
							<div class="col-12" style='text-align:center'>
								&copy;2015 <a href="http://aykutsimseks.com">Aykut Simsek</a> | Data from <a href='http://www.imdb.com' target='_blank'><img height=20  style='vertical-align:-5px;' src="{{STATIC_URL}}projects/moviero/img/imdb.png"></img></a> | Using <a href='http://www.listjs.com/' target='_blank'>List.js</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- end of #container -->
		<script src='//cdn.jsdelivr.net/jquery.nouislider/8.0.2/nouislider.min.js'></script>
		<script>
			var start_date = dateVal(new Date('01-01-2011'));
			var end_date   = dateVal(new Date());
			var dateSlider = document.getElementById('date-slider');

			noUiSlider.create(dateSlider, {
				// Create two timestamps to define a range.
    			range: {
        			min: start_date,
        			max: end_date
    			},

				// Steps of one week
    			step: 1,

				// Two more timestamps indicate the handle starting positions.
    			start: [ dateVal(new Date('01-01-2015')), end_date],

				// Display a colored bar between the handles
				connect: true,
	
				// Move handle on tap, bar is draggable
				behaviour: 'tap-drag', 
			});


			var dateValues = [
				document.getElementById('event-start'),
				document.getElementById('event-end')
			];

			// Create a list of day and monthnames.
			var months = [ "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];


			dateSlider.noUiSlider.on('update', function( values, handle ) {
				var pre = ""
				if(handle == 0) pre = "From:"
				else pre = "To:"
				dateValues[handle].innerHTML = pre + "&nbsp;&nbsp;<span style='display:inline-block;'>" +formatDate(+values[handle]) +  "</span>";
			})

			dateSlider.noUiSlider.on('change', function( values, handle ) {
				start_date = +values[0];
				end_date   = +values[1];
				filterList(genre,start_date,end_date);
			});

			// Create a string representation of the date.
			function formatDate ( date ) {
				return 	months[date%12] + " " +
						parseInt(date/12);
			}

			function dateVal(d) {
				return d.getMonth() + d.getFullYear()*12
			}
		</script>
		<script>
			// Field Mapping from csv file
			var csv_file = '{{STATIC_URL}}projects/moviero/data/movies.csv'
			var featureList = null;
			var filterList  = null;
			var genre = null;
			
			
			d3.csv(csv_file, function(error, csv) {
				console.log(csv[0])
				csv.forEach(function(c, i) {
					$('#list').append(
						[
							'<li>',
							'<a href=' + c.url + ' target="_blank"><img height="140" width="200" src="{{STATIC_URL}}/projects/moviero/img/thumbnails/' + c.unique_id + '.png" class="thumb" /></a>',
							'<a href=' + c.url + ' target="_blank"><h4><span class="name">' + c.title + '</span></h4></a>',
							'<p>' + ((c.metascore != '')?('Metascore: <span class="metascore">' + c.metascore + '</span> | '):'') + c.run_time + ' min | <span class="genres">' + eval(c.genres).join(', ') + '</span> | <span>' + (months[c.month]||'') + '</span>, <span class="year">' + (c.year||'') + '</span></p></p>',
							'<span class="month" style="display:none;">' + (c.month||0) + '</span><span class="air_date" style="display:none;">' + (parseInt((c.month||0)) + parseInt((c.year||0))*12)+ '</span>',
							'<p><span class="description">' + c.description + '</span></p>',
							'<p> D: <span class="director">' + c.director + '</span> | S: <span class="stars">' + eval(c.stars).join(', ') + '</span></p>',
						].join('')
					)
				})
				init_list();
			})
		</script>
		<script>
			var init_list = function() {
				var genres = ["Action","Adventure","Animation","Biography","Comedy","Crime","Documentary","Drama","Family","Fantasy",/*"Film-Noir",*/"History","Horror","Music","Musical","Mystery","Romance","Sci-Fi","Sport","Thriller","War","Western"]
			
				genres.forEach(function(g) {
					$('.filter').append('<li class="btn">' + g + '</li>')
				})
			
				var options = {
					valueNames: [ 'name', 'description', 'metascore', 'genres', 'director', 'stars', 'month', 'year', 'air_date'],
					page: 20,
					plugins: [ ListPagination({'innerWindow': 1, 'outerWindow': 1}) ] 
				};
			
				featureList = new List('lovely-things-list', options);
				
				filterList = function(gen,start,end) {
					var g = gen||genre;
					var s = start||start_date;
					var e = end||end_date;
					featureList.filter(function(item) {
						var values = item.values()
				 		if (!g || g == "All" || values.genres.search(g) >= 0) {
				 			var air_date = parseInt(values.month) + parseInt(values.year)*12;
				 			if( air_date >= start_date && air_date <= end_date) { 
				 				//console.log(air_date + " " + start_date + " " + end_date)
					   			return true;
					   		}
					   	}
					 	return false;
					});
				}
				
				
				$('.filter li.btn').click(function() {
					genre = $(this).text();
					$(".filter li").removeClass("highlight");
					$(this).addClass("highlight");
					filterList(genre)
					return false;
				})
				
				start_date = dateVal(new Date('01-01-2014'))
				filterList('All',start_date,end_date);
				featureList.sort('metascore', { order: "desc" });
			}
		</script>
	</body>
</html>